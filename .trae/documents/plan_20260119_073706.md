# 异步反馈机制设计方案

## 问题分析
当前的 `send_command` 方法（行231-252）在发送UDP命令后会立即等待2秒响应，超时则返回错误。但有些命令可能需要长达8小时才能完成，这种同步等待机制无法满足需求。

## 解决方案设计

### 1. 命令执行模式区分
- **立即响应命令**：如状态查询、参数设置等，继续使用当前同步模式
- **长时间运行命令**：如反应器溶液添加、温度控制等，采用异步模式

### 2. 异步反馈机制实现
- **发送命令阶段**：发送命令后立即返回"accepted"状态，表示命令已被接收
- **状态更新阶段**：服务器在命令执行过程中通过UDP主动推送状态更新
- **执行完成阶段**：服务器在命令执行完成后推送包含任务结果的状态更新

### 3. 核心代码修改

#### 3.1 修改 `send_command` 方法（行189-257）
- 移除固定的2秒超时等待
- 增加命令类型判断逻辑
- 对于长时间运行命令，发送后立即返回成功状态
- 对于立即响应命令，继续等待响应

#### 3.2 扩展状态更新机制
- 为状态更新消息添加任务ID字段
- 增加任务执行状态字段（accepted, running, completed, failed）
- 在状态更新回调中处理任务结果

#### 3.3 增加任务追踪机制
- 维护任务ID与命令的映射关系
- 支持查询特定任务的执行状态

### 4. 具体实现步骤

1. **修改 `send_command` 方法**：
   - 增加命令类型配置（立即响应/长时间运行）
   - 发送命令后，对于长时间运行命令，立即返回成功
   - 移除固定的2秒超时等待

2. **扩展 `_listen_loop` 方法**：
   - 支持解析包含任务ID的状态更新
   - 增加任务状态处理逻辑

3. **增加任务管理功能**：
   - 添加任务ID生成和管理
   - 支持任务状态查询
   - 实现任务结果回调机制

4. **修改相关命令处理逻辑**：
   - 调整 `_send_command` 方法（行505-529）以适应异步模式
   - 更新状态更新处理逻辑

### 5. 预期效果
- 长时间运行命令能够被正确接收并执行
- 命令发送后立即返回，不阻塞主线程
- 服务器在命令执行过程中推送状态更新
- 命令执行完成后，客户端能够及时获取结果
- 支持查询命令执行状态

## 代码修改范围
- `UDPClient` 类的 `send_command` 方法
- `UDPClient` 类的 `_listen_loop` 方法
- 状态更新处理逻辑
- 命令执行结果处理逻辑